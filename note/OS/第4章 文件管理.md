# 第4章 文件管理

[TOC]

## 4.1 文件系统基础

### 4.1.1 文件的概念

#### 1. 文件的定义

&emsp;&emsp;文件是以**计算机硬盘**为载体的存储在计算机上的**信息集合**。

#### 2. 文件的属性

![image-20210722232001349](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722232001349.png)

#### 3. 要探讨的问题

##### （1）文件内部的数据应该怎样组织起来

![image-20210722232121637](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722232121637.png)

##### （2）文件之间应该怎样组织起来

![image-20210722232339198](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722232339198.png)

##### （3）操作系统应向上提供哪些功能（文件的基本操作）

![image-20210720153902460](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210720153902460.png)

+ 创建文件（&ensp;create&ensp;系统调用）
  + 进行 Create 系统调用时，需要提供的几个主要参数：
      1. 所需的外存空间大小（如：一个盘块，即1KB）
      2. 文件存放路径
      3. 文件名
  + 操作系统在处理 Create 系统调用时，主要做了两件事：
     1. **在外存中找到文件所需的空间**（文件存储空间管理策略）
     2. 根据文件存放路径的信息找到该目录对应的目录文件，在目录中**创建该文件对应的目录项**。目录项中包含了文件名、文件在外存中的存放位置等信息
+ 删除文件（&ensp;delete&ensp;系统调用）
  + 进行 Delete 系统调用时，需要提供的几个主要参数：
     1. 文件存放路径
     2. 文件名
  + 操作系统在处理 Delete 系统调用时，主要做了三件事：
     1. 根据文件存放路径找到对应的目录文件，从目录中**找到文件名对应的目录项**。
     2. 根据该目录项记录的文件在外存的存放位置、文件大小等信息，**回收文件占用的磁盘块**。
     3. 从目录表中**删除文件对应的目录项**。
+ 读文件（&ensp;read&ensp;系统调用）
  + 进程使用 read 系统调用完成读操作；需要提供的参数：
     1. 文件在打开文件表中的索引号（指明是哪个文件）
     2. 读入多少数据（如： 读入 1KB）
     3. 读入的数据要放在内存中的位置
  + 操作系统在处理 read 系统调用时，做的事情：
    + 从读指针指向的外存中，将用户指定大小的数据读入用户指定的内存区域中
+ 写文件（&ensp;write&ensp;系统调用）
  + 进程使用 write 系统调用完成写操作；需要提供的参数：
     1. 文件在打开文件表中的索引号（指明是哪个文件）
     2. 写入多少数据（如： 读入 1KB）
     3. 写回外存的数据放在内存中的什么位置
  + 操作系统在处理 write 系统调用时，做的事情：
    + 从用户指定的内存区域中，将指定大小的数据写回写指针指向的外存
+ 打开文件（&ensp;open&ensp;系统调用）` 读/写文件之前调用`
  + 很多操作系统中，在对文件进行操作之前，要求用户先使用 open 系统调用 ”打开文件“，需要提供的几个主要参数：
     1. 文件存放路径
     2. 文件名
     3. 要对文件的操作类型（如：r 只读；rw 读写等）
  + 操作系统在处理 open 系统调用时，主要做了几件事：
     1. 根据文件存放路径找到相应的目录文件，从目录中**找到文件名对应的目录项**，并检查该用户是否有指定的操作权限
     2. **将目录项复制到内存中的 ”打开文件表“ 中**。并将对应表目的编号返回给用户。之后**用户使用打开文件表的编号来指明要操作的文件**。（因此该操作可以大幅提高文件访问的速度）

+ 关闭文件（&ensp;close&ensp;系统调用）`读/写文件结束之后调用`
  + 进程使用完文件后，要 ”关闭文件“；操作系统在处理 Close 系统调用时，只要做了几件事：
     1. 将进程的打开文件表相应表项删除
     2. 回收分配给该文件的内存空间等资源
     3. 系统打开文件表的打开计数器 **count 减1**，若count = 0，则删除对应表项

**`可用几个基本操作完成更复杂的操作`**

**【注】只有在读文件时，才会把文件数据真正地从外存读入内存；在对文件进行读/写操作时，用户不需要再提供 文件名、文件路径 等信息，只需提供 文件描述符 即可。<br>		着重关注【打开文件】【读文件】**

![image-20210720170127094](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210720164754604.png)

##### （4）从上往下看，文件应如何存放在外存

![image-20210722233512729](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722233512729.png)

### 4.1.2 文件的逻辑结构

![image-20210722233716592](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722233716592.png)

#### 1. 无结构文件（流式文件）

&emsp;&emsp;文件内部的数据就是一系列二进制或字符流组成。又称&ensp;“流式文件” 。如&ensp;`.txt`&ensp;文件。

#### 2. 有结构文件（记录式文件）

&emsp;&emsp;由一组相似的记录组成，又称 “记录式文件” 。每条记录有若干个数据项组成。如：数据库表文件。一般来说，每条记录有一个数据项可作为**关键字**。根据每条记录的长度（占用的存储空间）是否相等，又可分为**定长记录**和**可变长记录**两种。

![image-20210722233849419](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722233849419.png)

**顺序文件**

![image-20210722234207774](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722234207774.png)

**索引文件**（解决变长记录文件只能顺序查找的问题）

![image-20210722234519846](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722234519846.png)

**索引顺序文件**（解决索引文件索引表可能会很大，存储空间利用率较低的问题）

&emsp;&emsp;索引文件和顺序文件思想的结合，同样会为文件建立一张索引表，但并不是每个记录对应一个索引表项，而是**一组记录对应一个索引表项**。

### 4.1.3 目录结构

![image-20210722234732969](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722234732969.png)

#### 1. 文件控制块

&emsp;&emsp;目录文件中的一条记录（目录项）就是一个 “文件控制块 (FCB) "。

![image-20210722234836889](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722234836889.png)

#### 2. 目录结构

**单级目录结构**

&emsp;&emsp;整个文件系统只建立一张目录表，每个文件占一个目录项；“按名存取”，**不允许文件重名**。<br>		不适用于多用户操作系统。

**两级目录结构**

​		分为**主文件目录(MFD)**和**用户文件目录（UFD）**。<br>		解决了不同用户文件的 “重名” 问题，又在一定程度上保证了文件的安全；但缺乏灵活性，不能对文件分类。

**多级目录结构（树形目录文件）**

​		用户（或用户进程）要访问某个文件时要用文件路径名标识文件；<br>		从**根目录**出发的路径称为**绝对路径**<br>		设置“**当前目录**”，可以使用**从当前目录出发**的”**相对路径**“<br>		可以很方便地对文件进行分类，层次结构清晰，也能更有效地进行文件的管理和保护。但查找一个文件时，需按路径名逐级访问中间结点，增加了磁盘访问次数，影响查询速度；而且不便于是实现文件地共享。

**无环图目录结构**

​		在树形目录结构基础上增加一些指向同一结点的有向边，即**用不同的文件名指向同一个文件**（甚至目录），使整个目录成为一个**有向无环图**，为该增加的结点，设置一个**共享计数器**，每当图中增加对该结点地共享链时，计数器+1，当某用户提出删除该结点时，计数器-1；仅当共享计数器为0时，才真正删除该结点，否则仅删除请求用户的共享链。<br>		**【注】**共享文件不同于复制文件，对于共享文件，由于各用户指向的是同一个文件，因此**只存在一个真正的文件，任何改变都会为其他用户所见**。

​		方便地实现了文件的共享，但使得系统的管理变得更加复杂。

#### 3. 索引结点（FCB的改进）

![image-20210722235001101](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210722235001101.png)

### 4.1.4 文件共享

**文件共享实现方式：**

+ 基于索引结点的共享方式（**硬链接**）
+ 基于符号链的共享方式（**软连接**）

**【注】**多个用户共享同一个文件，意味着系统中只有“一份”文件数据。并且只要某个用户修 改了该文件的数据，其他用户也可以看到文件数据的变化。
如果是多个用户都“复制”了同一个文件，那么系统中会有“好几份”文件数据。其中一个用 户修改了自己的那份文件数据，对其他用户的文件数据并没有影响。

![image-20210721091832866](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721091832866.png)

### 4.1.5 文件保护

**文件保护机制：**

+ 口令保护

  ​		口令一般存放在文件对应的 FCB 或索引结点中。

  + 优点：保存口令的空间开销不多，验证口令的时间开销也很小
  + 缺点：正确的 ”口令“ 存放在系统内部，不够安全

+ 加密保护

  + 优点：保密性强，不需要在系统中存储 “密码”
  + 缺点：编码/译码，或者说加密/解密要花费一定时间

+ 访问控制

  ​		在每个文件的FCB（或索引结点）中增加一个**访问控制列表**（Access-Control List, ACL），该表中记录了各个用户可以对该文件执行哪些操作。

![image-20210721093859694](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721093859694.png)

## 4.2 文件系统的实现

### 4.2.1 文件系统的层次结构

![image-20210721103249489](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721103249489.png)

### 4.2.2 目录实现

**基本方法：**

+ 线性列表（对应线性查找）
+ 哈希表（对应散列查找）

### 4.2.3 文件实现——文件分配方式

![image-20210720103406245](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210720103406245.png)

### 4.2.3 文件实现——文件存储空间管理

**1. 空闲表法**

**2. 空闲链表法**

+ 空闲盘块链
+ 空闲盘区链	


**3. 位示图法**

**4. 成组链接法**

![image-20210720130844000](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210720130844000.png)

## 4.3 磁盘组织与管理

### 4.3.1 磁盘的结构

#### 1. 主要结构：

+ 磁头
+ 磁道
+ 扇区

![image-20210721113342397](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721113342397.png)

+ 盘面
+ 柱面

![image-20210721113555620](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721113555620.png)

#### 2. 磁盘的分类

+ 根据磁头是否可移动
  + 固定头磁盘（每个磁道有一个磁头）
  + 移动头磁盘（每个盘面之有一个磁头）
+ 根据盘面是否可更换
  + 固定盘磁盘
  + 可换盘磁盘

### 4.3.2 磁盘调度算法

![image-20210721130904685](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721130904685.png)

​		一次磁盘读/写操作的时间由寻道时间、旋转延迟时间、传输时间决定。

+ 延迟时间和传输时间都与磁盘转速相关，且为线性相关。而转速是硬件的固有属性，因此操作系统也无法优化延迟时间和传输时间
+ 操作系统的**磁盘调度算法**会直接影响**寻道时间**

#### 1. 先来先服务算法（FCFS)

​		优点：公平；如果请求访问的磁道比较集中的话，算法性能还算过的去 

​		缺点：如果有大量进程竞争使用磁盘，请求访问的磁道很分散，则FCFS在性能上很差，寻道时间长。

#### 2. 最短寻找时间优先（SSTF）

​		优点：性能较好，平均寻道时间短 

​		缺点：可能产生 “饥饿” 现象<br>				产生饥饿的原因在于：磁头在一个小 区域内来回来去地移动。

#### 3. 扫描（SCAN）算法（电梯调度算法）

​		算法思想：**只有磁头移动到最外侧磁道的时候才能往内移动，移动到最内侧磁道的时候才能往外移动**。

​		优点：性能较好，平均寻道时间较短，**不会产生饥饿现象**

​		缺点：1. 只有到达最边上的磁道时才能改变磁头移动方向，事实上，处理了184号磁道的访问请 求之后就不需要再往右移动磁头了。<br>		2. SCAN算法对于各个位置磁道的响应频率不平均（如：假设此时磁头正在往右移动，且刚处理过 90号磁道，那么下次处理90号磁道的请求就需要等磁头移动很长一段距离；而响应了184号磁道 的请求之后，很快又可以再次响应184 号磁道的请求了）

#### 4. LOOK 调度算法

​		算法思想：**如果在磁头移动方向上已经没有别的请求，就可以立即改变磁头移动方向**。（边移动边观察，因此叫LOOK）解决了 SCAN 算法第一个缺点。

​		优点：比起 SCAN 算法来，不需要每次都移动到最外侧或最内侧才改变磁头方向，使寻道时间进 一步缩短。

#### 5. 循环扫描（C-SCAN）算法

​		算法思想：只有磁头朝某个特定方向移动时才处理磁道访问请求，而**返回时直接快速移动至起始端而不处理任何请求**。解决了 SCAN 算法第二个缺点。

​		优点：比起SCAN来，对于各个位置磁道的响应频率很平均。 

​		缺点：只有到达最边上的磁道时才能改变磁头移动方向，事实上，处理了184号磁道的访问请求之后就不需要再往右移动磁头了；并且，磁头返回时其实只需要返回到18号磁道即可，不需要返回到最边缘的磁道。另外，比起SCAN算法来，平均寻道时间更长。

#### 6. C-LOOK 调度算法

​		算法思想：如果磁头移动的方向上已经没有磁道访问请求了，就可以立即让磁头返回，并且磁头只需要返回到有磁道访问请求的位置即可。解决 C-SCAN 算法的缺点。

​		优点：比起 C-SCAN 算法，不需要每次都移动到最外侧或最内侧才改变磁头方向，使寻道时间进一步缩短。

![image-20210721140122405](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721140122405.png)

**减少延迟的方法**

![image-20210721162333271](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721162333271.png)

### 4.3.3 磁盘的管理

![image-20210721162514369](https://raw.githubusercontent.com/F-bee/professional_course_image/master/OS/image-20210721162514369.png)